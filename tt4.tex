\documentclass[10pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage{stmaryrd}
\usepackage{amssymb,amstext,amsmath}
\usepackage{mathtools}
\usepackage{mathpartir}
\usepackage{mytheorems}
\usepackage[a4paper,margin=1.8cm]{geometry}
\usepackage{fancyref}

\newcommand\CC[4]{(#2,_{#1} #3)}
\newcommand\CP[3]{(#2,_{#1} #3)}
\newcommand\CSig[1]{\Sigma^{#1}}
\newcommand\CTimes[3]{#2 ×_{#1} #3}
\newcommand\SW[2]{\mathsf{SW}^{#1}_{#2}}
\newcommand\sw[2]{\mathsf{sw}^{#1}_{#2}}
\newcommand\dom{\mathsf{dom}}
\newcommand\param[1]{\!\cdot\!#1}
\newcommand\pvar[2]{{#1}^{(#2)}}
\newcommand\op[1]{∋_{#1}}
\newcommand\ip[3]{Σ^{#1} {#2}\,{#3}}
\newcommand\fp[3]{⟨#2 ,_{#1} #3⟩}
\newcommand\proj[2]{⌊{#2}⌋_{#1}}
\input{unicodedefs}

\title{A parametric Type theory}

\author{}
\date{\today}

\begin{document}
\maketitle


\begin{definition}[Syntax of terms and contexts]
  \begin{align*}
    t,u,A,B & \coloneqq x \mid U \mid λx:A. t      \mid t u \mid (x:A) → B \\
            & \mid \CP i t u  \mid \ip i A B  \mid \fp i t u \\
            & \mid A \op i u \mid t \param i  \\
    \Gamma,\Delta & \coloneqq () \mid \Gamma,x:A
  \end{align*}
\end{definition}

We consider a total order $\preccurlyeq$ on colours (for uniqueness of
normal forms).
We use $I,J,…$ for finite {\em sets} of colours (order does not matter).

\begin{definition}[Typing relation]
Contexts:
  \begin{mathpar}
    \inferrule[Empty]{~}{() ⊢ }

    \inferrule[NewVar]{Γ⊢ \\ Γ ⊢ A : U }{ Γ,x:A ⊢ }

  \end{mathpar}
 
Types:
 \begin{mathpar}
    \inferrule[Universe]{Γ ⊢}{Γ ⊢_I U : U}

    \inferrule[Pi]{Γ ⊢_I A : U \\ Γ,x:A ⊢_I B : U}{Γ ⊢_I (x:A) → B : U}

    \inferrule[Out]{Γ ⊢_{I,i} T : U \\ Γ ⊢_I a : \proj i T}{Γ ⊢_I T \op i  a : U}

    \inferrule[In-Pred]{Γ ⊢_{I} A : U \\ Γ ⊢_{I} P : A → U}{Γ ⊢_{I,i} \ip i A P : U}

 \end{mathpar}

Terms:
  \begin{mathpar}
    \inferrule[Conv]{Γ ⊢_I t:A \\ A = B}{Γ ⊢_I t : B}

    \inferrule[Var]{Γ ⊢ \\ x : A ∈ Γ}{Γ ⊢_I x : A}


    \\\inferrule[Lam]{Γ,x:A ⊢_I B}{Γ ⊢_I λx:A.b : (x:A) → B}
 
    \inferrule[App]{Γ ⊢_I t : (x:A) → B[x] \\ Γ ⊢_I u : A}{Γ ⊢_I t u: B[u]}

    \\\inferrule[In-Abs]{Γ ⊢_I a : \proj i T \\Γ ⊢_I p : T \op i a}{Γ ⊢_{I,i} \CP i a p : T}

    \inferrule[In-Fun]
        {Γ ⊢_I f : \proj i {(x:A) → P x}\\\\
        Γ ⊢_I g : (x:\proj i A) → (x':A \op i x) → P \CP i x {x'} \op i f x}{Γ ⊢_{I,i} \fp i f g : (x:A) → P x}

    \inferrule[Color-elim]{Γ ⊢_{I,i} a : T}{Γ ⊢_I a \param i : T \op i {\proj i a}}


  \end{mathpar}
\end{definition}

\begin{definition}[Projection]~
  $\proj i \cdot$ is defined by induction on the syntax.
\begin{align*}
    \proj i {\fp i f g} & = f \\
  \proj i {(a,_i p)} &= a \\
  \proj i {\ip i A P} &= A
\end{align*}
+ congruences, such as
\begin{align*}
  \proj i {T \op j a} &= {\proj i T \op j \proj i a}
\end{align*}
\end{definition}


\begin{definition}[Normal forms and neutral terms]~
  \begin{align*}
    \mathsf{Nf} ∋ u,v,A,B & \coloneqq
      U \mid λx:A. t \mid (x:A) → B \\
      & \mid \CP i u v \mid \fp i u v \\
      & \mid {(\ip {i₀} A B)} \op {i₁} {u_1 \cdots} \op {i_n} {u_n} &\quad \text{($i₀ \prec i₁ \prec \ldots \prec i_n$)} \\
      & \mid s \param {i₀} \cdots \param {i_{n-1}}                  &\quad \text{($i₀ \prec   < \ldots \prec i_{n-1}$)}
    \\
    \mathsf{Ne} ∋ s & \coloneqq x \mid s \, u
  \end{align*}
\end{definition}

\begin{definition}[Untyped reduction]~

β:
\begin{align*}
  (λx:A. u[x]) t &→ u[t]
\end{align*}

Swaps:
\begin{align*}
  a \param j \param i &→ a \param i \param j             &\text{($i \prec j$)} \\
  T \op j \CP i a c \op i b &→ T \op i \CP j a b \op j c &\text{($i \prec j$)}
\end{align*}
Note: the above rule shows why ${} \param i {}$ is different from $\op i {}$.

Pair-like things:
\begin{align*}
  {\fp i f g} \, a      &→ (f\,{\proj i a} ,_i g\,{\proj i a}\,{(a \param i)}) \\
  {(a,_i p)} \param i   &→ p \\
  {(\ip i A P)} \op i a &→ P\,a
\end{align*}

Note: the param-witness construction is bootstrapped by the last rule.

\end{definition}

Confluence implies other equalities, such as:
\begin{align*}
  {(a,_j p)} \param i &→ (a \param i ,_j p \param i)\\
  \ip j {(A \op i {\proj i a})} {(λy. P \, \CP i {\proj i a} y \op i {(a \param j)})} &→ {(\ip j A P)} \op i a &\text{($i \prec j$)}
\end{align*}

+ congruences.

\begin{definition}[Conversion]
  Let $↔^★$ be the reflexive symmetric transitive closure of $→$.
  \begin{mathpar}
    \inferrule{t ↔^★ u} {t = u}
    \and
    \inferrule{t x = u} {t = λ x:A.u}
    \and
    \inferrule{\proj i t = a \\ t \param i = p} {t = \CP i a p }
  \end{mathpar}
\end{definition}




\section{Iterating Parametricity}
For any type $A$ (which may depend on colors $i,j$), we have
\begin{align*}
p &: (x:A) → A \op i x\\
p x &= x\param i\\
q &: (x:A) → (A \op i x) \op j x \param  i\\
  &: (x:A) → (A \op j \CP i x {x \param j}) \op j x \param  i\\
q x &= x\param i\param j
\end{align*}

\section{Link with "Old" parametricity}
We define a (unary) relational interpretation of types $⟦A⟧$. This
interpretation coincides with the usual relational interpretation of types.
We show that, if $⟦·⟧$ and $∋_i$ are equivalent for free type variables,
then they are equivalent for every type in normal form.

\begin{definition}
We define $⟦A⟧$ by structural induction on $A$.
  \begin{align*}
    ⟦A → B⟧ f & = (x:\proj i A) → ⟦A⟧ x → ⟦B⟧ (f x)\\
    ⟦U⟧ A & = A → U\\
    ⟦A \op j a ⟧ b &= ⟦A⟧ \CP j {\proj i a} b \op j a \param i \\
    ⟦\ip i A P⟧ x & = P x\\
    ⟦x⟧ a & = x \op i a
  \end{align*}
\end{definition}

\providecommand\TO{\overrightarrow}
\providecommand\FROM{\overleftarrow}

\begin{theorem}
For every type $A$, $A \op i x$ is provable iff. $⟦A⟧ x$ is provable.
\end{theorem}
Let us call $\TO A$ the conversion from $A \op i x$ to $⟦A⟧ x$; and $\FROM A$ the other direction.
\begin{proof}
  By structural induction on $A$. Key cases:
  \begin{itemize}
  \item Pi.
    Assume:
    \begin{itemize}
    \item $f : A → B$
    \item $p : (A → B) \op i f$
    \end{itemize}
    We prove $q : (x:A) → ⟦A⟧ x → ⟦B⟧ (f x)$ with $q x x' = \TO {B[\CP i x {\FROM A x'}]} ((\CP i f
    p \CP i x {\FROM A x'}) \param i)$.

    (No need to carry around an environment; the proof given by the
    user ($x'$) is substituted in terms)

    Right to left: $p = (\fp i f {λx. λx'. \FROM {B[\CP i x {x'}]} (q x (\TO A x'))}) \param i $

  \item Universe.

    Left to right. Assume:
    \begin{itemize}
    \item $A : U$
    \item $P : U \op i A $
    \end{itemize}
    We prove $Q : A → U$ with $Q x = \CP i A P \op i x$.
 

    Right to left: $P = (\ip i A Q) \param i $

  \item Sigma.
    By def.
  \item Param.

    Left to right. Assume:
    \begin{itemize}
    \item $a : A$
    \item $b : A\op j a$
    \item $p : A \op j a \op i b $
    \end{itemize}
    We prove $q' : A \op i \CP j {\proj j a} b \op j a \param i  $ with $\CP i a {\CP j b p} \param j \param i$.
    The result is given by $\TO A q'$.

    Right to left: same principle.
  \end{itemize}
  \item Variable.
    By def.
\end{proof}

\subsection{Example: naturals}
Let $N = ∀X. X → (X → X) → X$.
Proving (unary) parametricity for $N$ means that, assuming
\begin{itemize}
\item $f : N$
\item $A : U$
\item $P : A → U$
\item $z : A$
\item $z' : P z$
\item $s : A → A$
\item $s' : (x:A) → P x → P (s x)$
\end{itemize}
we can prove $P (f A z s)$.

Indeed, a proof term is the following:

\[
(f (\ip i A P) \CP i z {z'} \fp i s {s'}) \param i
\]

\end{document}
